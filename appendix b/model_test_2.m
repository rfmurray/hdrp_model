% model_test_2.m  Test rendering and post-processing models for Lambertian
%                 and unlit materials

% See readme_appendix_b.txt for details about how to run this test.

clear; clc;

% addpath ../tools
addpath tools

% choose whether to test results from model_test Unity project with
% Lambertian or unlit material
testLambertian = true;
testTonemapping = false;
cubefile = 'square_root.cube';

% load data generated by Unity project render_random for this condition
% fname = filename(testLambertian, testTonemapping);
fname = 'data_L1_T0_F0_A1_S05000_M1.txt';
data = readtable(fname);

% tranform data into model parameters
m = [ data.m_r data.m_g data.m_b ];
d = [ data.d_r data.d_g data.d_b ];
a = [ data.a_r data.a_g data.a_b ];
v = [ data.v_r data.v_g data.v_b ];
i_d = data.i_d;
i_a = data.i_a;
costheta = data.l_x .* data.n_x + data.l_y .* data.n_y + data.l_z .* data.n_z;

% apply Lambertian or unlit rendering model
if testLambertian
    c = 0.822;
    u_hat = c * srgb(m) .* ( i_d .* srgb(d) .* max(costheta, 0) / pi + i_a .* a );
else
    u_hat = srgb(m);
end

% apply tonemapping
if testTonemapping
    tonemap = TonemapCube(cubefile);
    % tonemap.u_knot = [ 0 1e-09 1.402e-05 0.003089 0.007417 0.01272 0.021 0.03146 0.04521 0.06482 0.09131 0.126 0.1736 0.2381 0.3303 0.4483 0.6096 0.8295 1.124 1.498 2.039 2.766 3.76 5.072 6.871 9.398 12.65 17.25 23.25 31.41 43.01 57.74 ];
    % tonemap.makecoord;
    t_hat = tonemap.apply(u_hat);
else
    t_hat = u_hat;
end

% apply sRGB nonlinearity to get post-processed color coordinates v_k
v_hat = srgbinv(t_hat);

% plot predicted post-processed color coordinates v_k against actual v_k
figure(1);
xylim = [ 0 1 ];
h = scatter(v,v_hat,80,[ 1 0 0 ; 0 1 0 ; 0 0 1 ],'filled');
legend(h, 'red channel', 'green channel', 'blue channel', 'location', 'northwest', 'box', 'off', 'AutoUpdate', 'off');
hold on
plot(xylim, xylim, 'k-');
hold off
box on
axis square
axis([ xylim xylim ]);
xlabel 'actual v_k'
ylabel 'predicted v_k'
set(gca,'FontSize',18);

% plot prediction error in v_k against actual v_k
figure(2);
xlim = [ 0 1 ];
h = scatter(v,v_hat-v,80,[ 1 0 0 ; 0 1 0 ; 0 0 1 ],'filled');
hold on
plot(xlim,(-1/255)*[ 1 1 ],'k-');
plot(xlim,(1/255)*[ 1 1 ],'k-');
hold off
box on
axis square
axis([ xlim (5/255)*[ -1 1 ] ]);
xlabel 'actual v_k'
ylabel 'prediction error for v_k'
legend(h, 'red channel', 'green channel', 'blue channel', 'location', 'northwest', 'box', 'off');
set(gca,'FontSize',18);

% function f = filename(lambertian, tonemap)
% f = 'model_test/data';
% if lambertian
%     f = [ f '_lambertian' ];
% else
%     f = [ f '_unlit'; ];
% end
% if tonemap
%     f = [ f '_tonemap' ];
% else
%     f = [ f '_notonemap' ];
% end
% f = [ f '.txt' ];
% end
